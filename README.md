# 🎬 LianWall

智能动态壁纸管理器 - 基于负反馈闭环调节的壁纸轮换系统

## ✨ 特性

- **负反馈闭环调节** - 有记忆的随机，避免重复和埋没
- **空间化选择逻辑** - 二分切割算法，自然有机的播放序列
- **多引擎支持** - mpvpaper（动态）/ swww（静态）
- **持久化权重** - 重启后保留壁纸"地形"状态

## 📦 安装

```bash
cargo build --release
cp target/release/lianwall ~/.local/bin/
```

## 🚀 使用

```bash
lianwall daemon   # 启动后台守护进程，定时切换壁纸
lianwall next     # 立即切换到下一张壁纸
lianwall reset    # 热重载：重新扫描目录并更新权重
lianwall status   # 显示当前状态和壁纸列表
```

### Hyprland 配置

```conf
exec-once = lianwall daemon
```

## ⚙️ 配置

配置文件位置：`~/.config/lianwall/config.toml`

```toml
[paths]
cache_file = "~/.cache/lianwall.json"
video_dir = "~/Videos/background"
image_dir = "~/Pictures/wallpapers"

[engine]
type = "mpvpaper"  # 或 "swww"
interval = 600     # 切换间隔（秒）

[weight]
base = 100.0           # 基础权重
select_penalty = 10.0  # 选中惩罚
skip_reward_max = 5.0  # 最大未选中奖励
```

---

## 🧠 算法设计解析

### 一、权重模型

```
┌─────────────────────────────────────────────────────────────────┐
│                      权重动态平衡系统                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   初始状态：根据文件修改时间                                        │
│   ┌──────────────────────────────────────────────────────┐      │
│   │  新文件 ───────────────────────────────────► 旧文件   │      │
│   │   120                    100                   80     │      │
│   └──────────────────────────────────────────────────────┘      │
│                                                                  │
│   选中惩罚：-10.0（立即进入冷却期）                                 │
│   ┌──────┐                                                       │
│   │ 100  │ ─── 被选中 ──► │ 90 │                                │
│   └──────┘                └────┘                                 │
│                                                                  │
│   跳过奖励：递增式 +1 ~ +5（越久不播，奖励越高）                     │
│   ┌─────────────────────────────────────────────────────┐       │
│   │ 跳过次数:  1-2   3-4   5-6   7-8   9+               │       │
│   │ 奖励值:    +1    +2    +3    +4    +5 (封顶)        │       │
│   │           + 随机扰动 ±0.3                           │       │
│   └─────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────┘
```

### 二、二分选择算法

```
排序后的壁纸列表（按权重从高到低）：

    权重:  105   103   102   101   100   95   90   85   80
    索引:   0     1     2     3     4    5    6    7    8
           ▲─────────────────────▲
           │    tolerance = 5    │
           │  (105-5=100 范围内)  │
           └──────────┬──────────┘
                      │
              找出 5 个候选项
              取中间位置 = 5/2 = 2
                      │
                      ▼
                选择索引 2（权重 102）
```

**为什么取中间而不是最高？**
- 避免贪心算法总是选第一个
- 打破文件名排序带来的初始偏差
- 引入"伪随机性"，让播放序列更自然

### 三、生态圈效果

```
时间轴演示（假设 20 个壁纸，每 10 分钟切换）：

T=0    所有壁纸初始权重 80~120
       ┌────────────────────────────────────────┐
       │▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓│  起伏地形
       └────────────────────────────────────────┘

T=1    壁纸A被选中 → 权重 -10，其他 +1~+5
       ┌────────────────────────────────────────┐
       │▓▓▓▓░░▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓│  A形成"坑"
       └──────┬─────────────────────────────────┘
              A

T=10   A已跳过10次，奖励累积 → 权重逐渐回升
       ┌────────────────────────────────────────┐
       │▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓│  趋于平衡
       └────────────────────────────────────────┘

长期效果：形成"波浪式"轮换
       ┌─────────────────────────────────────────────────────┐
       │  A ──► B ──► C ──► D ──► ... ──► A（经过足够间隔）   │
       │                                                      │
       │  不会出现: A ──► B ──► A（审美疲劳）                  │
       │  也不会有: X 永远不被选中（被埋没）                    │
       └─────────────────────────────────────────────────────┘
```

### 四、与传统随机对比

| 特性           | 传统随机 (shuf) | LianWall           |
| -------------- | --------------- | ------------------ |
| **记忆性**     | ❌ 无记忆        | ✅ 有权重记忆       |
| **公平性**     | ❌ 可能永久埋没  | ✅ 递增奖励保证出头 |
| **间隔控制**   | ❌ 可能 A→B→A    | ✅ 惩罚机制拉开间隔 |
| **新文件照顾** | ❌ 随机概率      | ✅ 高初始权重       |
| **持久化**     | ❌ 重启归零      | ✅ JSON 保存地形    |
| **可预测性**   | 完全随机        | 伪随机 + 有机感    |

### 五、参数验证

**数学验证（20个壁纸）：**

```
假设：
- 初始平均权重 = 100
- 选中惩罚 = -10
- 平均跳过奖励 ≈ +2（考虑递增）

每轮：
- 1个壁纸 -10
- 19个壁纸 平均 +2 = +38 总增量

系统总权重变化：-10 + 38 = +28（轻微膨胀）

恢复周期估算：
- 壁纸被选中后权重 90
- 每轮未选中 +2（平均）
- 恢复到 100 需要 5 轮 = 50 分钟
- 恢复到竞争力 (105+) 需要约 8 轮 = 80 分钟
```

**结论：** 参数合理，形成约 **1-2 小时** 的自然轮换周期。

---

## 📁 项目结构

```
src/
├── main.rs             # 总入口，命令分发
├── config.rs           # 配置文件解析
├── manager.rs          # WallManager 核心逻辑
├── command.rs          # 命令行解析 (clap)
├── paperengine/        # 壁纸引擎
│   ├── mod.rs          # PaperEngine trait
│   ├── mpvpaper.rs     # 动态壁纸 (视频)
│   └── swww.rs         # 静态壁纸 (图片)
└── algorithm/          # 算法模块
    ├── mod.rs
    ├── weight.rs       # 权重计算
    └── selector.rs     # 二分选择
```

## 📜 License

MIT
